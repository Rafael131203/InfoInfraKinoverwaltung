name: kinoapp-stack

services:
  # ---------- PostgreSQL (relational) ----------
  postgres:
    image: postgres:16
    container_name: kinoapp-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-kinoapp}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-kinoapp}"]
      interval: 5s
      timeout: 5s
      retries: 20
    networks: [kino-net]

  # ---------- MongoDB ----------
  mongodb:
    image: mongo:7
    container_name: kinoapp-mongodb
    restart: unless-stopped
    command: ["--bind_ip_all"]
    ports:
      - "27018:27017"
    volumes:
      - mongodata:/data/db
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval 'db.adminCommand({ ping: 1 })' || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 30
    networks: [kino-net]

  # ---------- Redpanda (Kafka-compatible broker) ----------
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v24.2.11
    container_name: kinoapp-redpanda
    hostname: redpanda
    command:
      - redpanda start
      - --overprovisioned
      - --smp=1
      - --memory=1G
      - --reserve-memory=0M
      - --node-id=0
      - --check=false
      # Internal Listener f端r Docker (9092), External Listener f端r Windows (19092)
      - --kafka-addr=internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr=internal://redpanda:9092,external://localhost:19092
      - --pandaproxy-addr=internal://0.0.0.0:8082,external://0.0.0.0:8083
      - --advertise-pandaproxy-addr=internal://redpanda:8082,external://localhost:8083
      - --rpc-addr=0.0.0.0:33145
      - --advertise-rpc-addr=redpanda:33145
    ports:
      # Mapping f端r externen Zugriff (Visual Studio)
      - "19092:19092"
      # Admin Ports
      - "${REDPANDA_ADMIN_PORT:-9644}:9644"
      - "${REDPANDA_SCHEMA_PORT:-18081}:8081"
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster info --brokers redpanda:9092 >/dev/null 2>&1 || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 30
    networks: [kino-net]

  # ---------- KinoApp API (.NET backend) ----------
  kinoapp-api:
    build:
      context: .
      dockerfile: ./KinoAppService/Dockerfile
    container_name: kinoapp-api
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      postgres:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    environment:
      ASPNETCORE_URLS: ${ASPNETCORE_URLS:-http://+:5000}
      ASPNETCORE_ENVIRONMENT: Docker
      # Verbindung innerhalb des Docker-Netzwerks 端ber den internen Namen und Port
      Kafka__BootstrapServers: "redpanda:9092"
    ports:
      - "${APP_PORT:-5000}:5000"
    healthcheck:
      test: ["CMD-SHELL","wget -qO- http://localhost:5000/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
    networks: [kino-net]

networks:
  kino-net:
    driver: bridge

volumes:
  pgdata:
  mongodata:
  redpanda-data: