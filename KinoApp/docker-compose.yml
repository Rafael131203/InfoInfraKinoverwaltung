name: kinoapp-stack

services:
  # ---------- PostgreSQL (relational) ----------
  postgres:
    image: postgres:16
    container_name: kinoapp-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-kinoapp}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-kinoapp}"]
      interval: 5s
      timeout: 5s
      retries: 20
    networks: [kino-net]

  # ---------- MongoDB ----------
  mongodb:
    image: mongo:7
    container_name: kinoapp-mongodb
    restart: unless-stopped
    command: ["--bind_ip_all"]   # simple single-node Mongo
    ports:
      - "${MONGO_PORT:-27017}:27017"
    volumes:
      - mongodata:/data/db
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval 'db.adminCommand({ ping: 1 })' || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 30
    networks: [kino-net]

  # ---------- Redpanda (Kafka-compatible broker) ----------
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v24.2.11
    container_name: kinoapp-redpanda
    hostname: redpanda # ADDED: evtl. konnte deshalb der Host nicht gefunden werden
    command:
      - redpanda start
      - --overprovisioned
      - --smp=1
      - --memory=1G
      - --reserve-memory=0M
      - --node-id=0
      - --check=false
      - --kafka-addr=PLAINTEXT://0.0.0.0:9092
      - --advertise-kafka-addr=PLAINTEXT://localhost:9092
      - --rpc-addr=0.0.0.0:33145
      - --advertise-rpc-addr=redpanda:33145
      - --pandaproxy-addr=0.0.0.0:8082
      - --advertise-pandaproxy-addr=redpanda:8082
      - --schema-registry-addr=0.0.0.0:8081
    ports:
      - "${REDPANDA_KAFKA_PORT:-9092}:9092"
      - "${REDPANDA_ADMIN_PORT:-9644}:9644"
      - "${REDPANDA_PROXY_PORT:-8083}:8082"
      - "${REDPANDA_SCHEMA_PORT:-18081}:8081"
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster info --brokers redpanda:9092 >/dev/null 2>&1 || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 30
    networks: [kino-net]

  # ---------- KinoApp API (.NET backend) ----------
  kinoapp-api:
    build:
      context: .
      dockerfile: ./KinoAppService/Dockerfile
    container_name: kinoapp-api
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      postgres:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redpanda:
        condition: service_healthy

    environment:
      ASPNETCORE_URLS: ${ASPNETCORE_URLS:-http://+:5000}

      # FIX: Force environment inside the container
      ASPNETCORE_ENVIRONMENT: Docker

      Kafka__BootstrapServers: "redpanda:9092"
    ports:
      - "${APP_PORT:-5000}:5000"
    healthcheck:
      test: ["CMD-SHELL","wget -qO- http://localhost:5000/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
    networks: [kino-net]

networks:
  kino-net:
    driver: bridge

volumes:
  pgdata:
  mongodata:
  redpanda-data:
